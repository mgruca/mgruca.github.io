---
layout: post
title: Ile metod ZAWSZE nadpisujesz w swoich obiektach?
date: 2011-06-05 14:02:32.000000000 +01:00
type: post
published: true
status: publish
categories:
- Tech
tags: []
---
<p>Hej, dziś temat mający korzenie w korytarzach hotelu gdzie odbywało się 33degree.</p>
<p>Podczas jednej z przerw rozpoczeliśmy dyskusję nad odwiecznym problemem w javie: ile metod i kiedy powinno się nadpisywać z klasy Object. By zacieśnić grono podejrzanych metod: rozmawialiśmy o hashCode, equals, toString. Całość w kontekście naszych aplikacji wykorzystujących Hibernate'a. Cała sprawa dotyczy też jedynie obiektów VO (Value Object), entities, DTO (Data Transfer Object) a nie services, controllers i innych DAO i managerów.</p>
<p>Jako wstęp do wpisu zachęcam do przeczytania kilku zasad tworzenia dobrych metod equals i hashCode, zebranych przez Andrzeja Ludwikowskiego w wpisach na jego blogu: <a title="Andrzej Ludwikowski - tworzenie metody equals" href="http://aludwikowski.blogspot.com/2011/02/metody-equlas-i-hashcode-w-javie.html" target="_blank">equals</a> i <a title="Andrzej Ludwikowski - tworzenie metody hashCode" href="http://aludwikowski.blogspot.com/2011/03/metoda-hashcode-w-javie.html" target="_blank">hashcode</a>. Jeśli ktoś nie czytał, a pisze kod w javie, to obowiązkowo zalecam też lekturę książki Joshua Blocha <a title="Amazon - effective Java 2nd edition" href="http://www.amazon.com/Effective-Java-2nd-Joshua-Bloch/dp/0321356683/ref=sr_1_1?ie=UTF8&amp;qid=1305458808&amp;sr=8-1" target="_blank">Effective Java</a>. Joshua dokładnie wyjaśnia wady i zalety oraz jak nadpisywać wszystkie 3 wymienione metody.</p>
<p>Główną linią podziału pomiędzy nami było czy w equals i hashCode korzystać z ID generowanego przez hiberneta czy nie oraz czy nadpisywać metodę toString. Moim zdaniem korzystanie z id hibernatowego ma zalety do których należy</p>
<ul>
<li>Pewność podczas identyfikacji obiektu. ID jest niepowtarzalne. Jeśli dwa obiekty są róne po porównaniu przez ID to na pewno jest to ten sam obiekt. Uwaga: owy obiekt może być w innym stanie, ale to historia na inny wpis.</li>
<li>Kolejną zaletą jest <em>zwalenie</em> odpowiedzialności za utworzenie identyfikatora na kogoś innego (czyt. Hibernate-a).</li>
<li>Przeważnie nikt też nie wpadnie na <em>genialny</em> pomysł zmiany wartości, którą postanowiliście zastosować do porównywania równości i generowania hashu (magia dwóch liter ID ;))</li>
</ul>
<p>Są jednak też wady, a podstawową jest to, że ID potrzebne do obu metod będzie dostępne dopiero po zapisie obiektu do bazy danych. Można to obejść, ale przeważnie w mało ładny sposób, który może nas później ugryźć w najmniej odpowiednim momencie, pomińmy więc tą możliwość.</p>
<p>Dla wielu osób nie musi wyglądać to na poważny problem, ale niestety nim jest. Zastanówmy się teraz czy istnieje możliwość, że korzystamy z obiektów przed dodaniem ich do bazy?</p>
<p>Jeśli tak to trzeba się zabezpieczyć przed nullem w  id. Jak to zrobić?</p>
<ol>
<li>Możemy sprawdzać czy id == null i jeśli tak to zwracamy jakąś stałą, np String.EMPTY, zero, etc. Nie wydaje się to być złe, nigdy nie dostaniemy NPE. Jednak problem pojawia się gdy korzystamy z kolekcji, szczególnie haszujących. Z powodu tego, że 2 obiekty będą dla systemu identyczne, możliwe jest doprowadzenie do utraty danych. Problemem jest również korzystanie z obiektu po zapisaniu go do DB. Zmienia się ID (na wygenerowane przez hiberneta) więc próba skorzystania z metoda takich jak .contains(obj) zakończy się niepowodzeniem. Możemy na przykład wyświetlić tą samą informację na ekranie dwukrotnie.</li>
<li>Możemy przed użyciem obiektu zapisywać go do bazy danych/pobierać przed skorzystaniem  z niego numer ID. Rozwiązanie pozbawione powyższych wad, jednak w wielu systemach zupełnie nie akceptowalne. Podstawowa wada to utrata kolejnego numeru ID oraz czasu potrzebnego na komunikację z bazą. Jeśli wyświetlamy numer ID użytkownikowi, może go zdziwić, że po zamówieniu nr  6, kolejne zamówienie ma numer 30. Inną sprawą jest, że ID bazodanowe nie powinno być prezentowane użytkownikowi, ale chyba każdy z nas miał gdzieś okazję widzieć system, który łamał tę zasadę.  Komunikacja z bazą to za to zupełnie inny problem. Jeśli mamy jakąś formę wizarda to wypadało by zadbać by obiekty stworzone przez użytkowników, a nigdy nie dokończone, zostały kiedyś usunięte z bazy. I kolejny problem wtedy mamy</li>
</ol>
<p>Wracając do sedna i tego co Pan Michał radzi: da się uniknąć wykorzystywania ID w hashcode i equals więc starajmy się tego unikać. Pisząc encje zidentyfikujmy <span style="text-decoration:underline;">niezmienne</span> własności obiektu i wykorzystajmy je w equals i hascode. Dobrymi kandydatami są data powstania obiektu czy wymagane pola, których później się nie da zmienić np login. Wykorzystując kombinację takich danych da się dobrze identyfikować obiekty i nie trzeba przy każdym obiekcie zastanawiać się nad strategią zapisywania do bazy.</p>
<p>Czasem można wykorzystać też dane zmienne w czasie. Jeden z dyskutantów podał przykład z aplikacji nad którą aktualnie pracował. System służy do przeprowadzania ankiet. Według autora, nie ma problemu w wcześniejszym zapisaniu danych w bazie, przed rozpoczęciem korzystania z nich. Nie zdążyliśmy dokończyć dyskusji na ten temat, ale oto moja propozycją dla tego typu zagadnień.</p>
<p>Jeśli posiadacie ograniczony zbiór możliwych obiektów to może nie warto zapisywać każdego z nich, tylko agregować je. Łatwo to uzyskać poprzez porównywanie wszystkich pól w obiekcie.</p>
<p>Weźmy za przykład ankietę z dwoma pytaniami i trzema możliwymi odpowiedziami na każde z nich. Dla takiej ankiety istnieje zbiór 9 możliwych do utworzenia obiektów. Jeśli wypełni ankietę 1000 użytkowników to my nie będziemy gromadzić 1000 rekordów a jedynie 9. Spora oszczędność.</p>
<p>Co zrobić jeśli mamy ankiety z pytaniami otwartymi i zamkniętymi? Nikt nie powiedział, że ankieta (a w zasadzie odpowiedzi do ankiety) musi być obiektem monolitycznym. Obiekt odpowiedzi możemy podzielić na podklasy: odpowiedzi do części otwartej i zamkniętej. Część zamknięta jest agregowana w wyżej opisane sposób, otwarta tradycyjnie. Sama tabela odpowiedzi staje się jedynie łącznikiem pomiędzy użytkownikiem, odpowiedziami do każdej części oraz samym zestawem pytań.</p>
<p>Na koniec  słowo o metodzie toString(). Większość dyskutantów stwierdziła, że jej nie nadpisuje. Jako powód wymienili przykład z Effective Java, gdize Joshua podaje jako zagrożenie, możliwość rozpoczęcia parsowania przez użytkowników, wartości zwracanych z toStringa. Dla mnie to przykład jedynie książkowy, być może z racji tego jak projektuję aplikację.</p>
<p>Nie uważam, by ukrywanie stanu w ValueObjects (do których zaliczam encje), było wskazane, gdyż może prowadzić jedynie do takich absurdów jak parsowanie toString czy nadużywania refleksji. Ok, kwestia tego jak piszemy aplikacje, jednak jeśli nie nadpisujecie toString, z wyżej wymienionego powodu, to nie wystawiajcie innej metody, która działa jak toString a jedynie inaczej się nazywa (zaproponowane podczas tej dyskusji).</p>
<p>Nie unikniecie problemów związanych z parsowaniem stringów a jeydnie skomplikujecie sobie życie. Jeśli już więc unikamy toString, to wystawmy, przez odpowiedni interface,  zestaw metod do komunikacji, np myNoToStringObject.log.(LoggerAdapter, logLevel, logTemplate). Nie unikniemy wprawdzie tego, że ktoś przekaże nam własną implementację loggerAdaptera i i tak sparsuje Stringa, ale może choć utrudnimy mu życie na tyle, że zrezygnuje ;) Temat jest jednak dość obszerny by stworzyć kolejny wpis.</p>
<p>Tymczasem w komentarzach wpisujcie swoje przemyślenia i dajcie znać ile wy metod zawsze nadpisujecie w obiektach.</p>
<div id="W_x_sticky_0" style="display:none;text-align:left;font-family:'Helvetica Neue', Helvetica, Arial, san-serif;font-style:normal;font-variant:normal;font-weight:400;font-size:14px;line-height:1.5;position:absolute;width:250px;z-index:99999;left:10px;background-color:#fdfdbe;box-shadow:3px 3px 10px;top:25px;">
<div id="W_x_sticky_header_0" style="background:#f3f3f3;height:20px;border-bottom:2px solid #fefefe;box-shadow:0 3px 5px rgba(0,0,0,0.25);padding:5px;"><span id="W_x_sticky_status_0" style="height:15px;float:left;margin:0;padding:3px;">Save</span> <span id="W_x_sticky_close_0" style="height:15px;float:right;margin:0;padding:3px;">Hide</span></div>
<div id="W_x_sticky_content_0" style="min-height:100px;word-wrap:break-word;border-left:3px double rgba(238,150,122,.75);margin-left:20px;padding:1px 5px;">Note Here</div>
</div>
<div id="W_x_sticky_0" style="display:none;text-align:left;font-family:'Helvetica Neue', Helvetica, Arial, san-serif;font-style:normal;font-variant:normal;font-weight:400;font-size:14px;line-height:1.5;position:absolute;width:250px;z-index:99999;left:10px;background-color:#fdfdbe;box-shadow:3px 3px 10px;top:25px;">
<div id="W_x_sticky_header_0" style="background:#f3f3f3;height:20px;border-bottom:2px solid #fefefe;box-shadow:0 3px 5px rgba(0,0,0,0.25);padding:5px;"><span id="W_x_sticky_status_0" style="height:15px;float:left;margin:0;padding:3px;">Save</span> <span id="W_x_sticky_close_0" style="height:15px;float:right;margin:0;padding:3px;">Hide</span></div>
<div id="W_x_sticky_content_0" style="min-height:100px;word-wrap:break-word;border-left:3px double rgba(238,150,122,.75);margin-left:20px;padding:1px 5px;">Note Here</div>
</div>
<div id="W_x_sticky_0" style="display:none;text-align:left;font-family:'Helvetica Neue', Helvetica, Arial, san-serif;font-style:normal;font-variant:normal;font-weight:400;font-size:14px;line-height:1.5;position:absolute;width:250px;z-index:99999;left:10px;background-color:#fdfdbe;box-shadow:3px 3px 10px;top:25px;">
<div id="W_x_sticky_header_0" style="background:#f3f3f3;height:20px;border-bottom:2px solid #fefefe;box-shadow:0 3px 5px rgba(0,0,0,0.25);padding:5px;"><span id="W_x_sticky_status_0" style="height:15px;float:left;margin:0;padding:3px;">Save</span> <span id="W_x_sticky_close_0" style="height:15px;float:right;margin:0;padding:3px;">Hide</span></div>
<div id="W_x_sticky_content_0" style="min-height:100px;word-wrap:break-word;border-left:3px double rgba(238,150,122,.75);margin-left:20px;padding:1px 5px;">Note Here</div>
</div>
<div id="W_x_sticky_0" style="display:none;text-align:left;font-family:'Helvetica Neue', Helvetica, Arial, san-serif;font-style:normal;font-variant:normal;font-weight:400;font-size:14px;line-height:1.5;position:absolute;width:250px;z-index:99999;left:10px;background-color:#fdfdbe;box-shadow:3px 3px 10px;top:25px;">
<div id="W_x_sticky_header_0" style="background:#f3f3f3;height:20px;border-bottom:2px solid #fefefe;box-shadow:0 3px 5px rgba(0,0,0,0.25);padding:5px;"><span id="W_x_sticky_status_0" style="height:15px;float:left;margin:0;padding:3px;">Save</span> <span id="W_x_sticky_close_0" style="height:15px;float:right;margin:0;padding:3px;">Hide</span></div>
<div id="W_x_sticky_content_0" style="min-height:100px;word-wrap:break-word;border-left:3px double rgba(238,150,122,.75);margin-left:20px;padding:1px 5px;">Note Here</div>
</div>
<div id="W_x_sticky_0" style="display:none;text-align:left;font-family:'Helvetica Neue', Helvetica, Arial, san-serif;font-style:normal;font-variant:normal;font-weight:400;font-size:14px;line-height:1.5;position:absolute;width:250px;z-index:99999;left:10px;background-color:#fdfdbe;box-shadow:3px 3px 10px;top:25px;">
<div id="W_x_sticky_header_0" style="background:#f3f3f3;height:20px;border-bottom:2px solid #fefefe;box-shadow:0 3px 5px rgba(0,0,0,0.25);padding:5px;"><span id="W_x_sticky_status_0" style="height:15px;float:left;margin:0;padding:3px;">Save</span> <span id="W_x_sticky_close_0" style="height:15px;float:right;margin:0;padding:3px;">Hide</span></div>
<div id="W_x_sticky_content_0" style="min-height:100px;word-wrap:break-word;border-left:3px double rgba(238,150,122,.75);margin-left:20px;padding:1px 5px;">Note Here</div>
</div>
<div id="W_x_sticky_0" style="display:none;text-align:left;font-family:'Helvetica Neue', Helvetica, Arial, san-serif;font-style:normal;font-variant:normal;font-weight:400;font-size:14px;line-height:1.5;position:absolute;width:250px;z-index:99999;left:10px;background-color:#fdfdbe;box-shadow:3px 3px 10px;top:25px;">
<div id="W_x_sticky_header_0" style="background:#f3f3f3;height:20px;border-bottom:2px solid #fefefe;box-shadow:0 3px 5px rgba(0,0,0,0.25);padding:5px;"><span id="W_x_sticky_status_0" style="height:15px;float:left;margin:0;padding:3px;">Save</span> <span id="W_x_sticky_close_0" style="height:15px;float:right;margin:0;padding:3px;">Hide</span></div>
<div id="W_x_sticky_content_0" style="min-height:100px;word-wrap:break-word;border-left:3px double rgba(238,150,122,.75);margin-left:20px;padding:1px 5px;">Note Here</div>
</div>
<div id="W_x_sticky_0" style="display:none;text-align:left;font-family:'Helvetica Neue', Helvetica, Arial, san-serif;font-style:normal;font-variant:normal;font-weight:400;font-size:14px;line-height:1.5;position:absolute;width:250px;z-index:99999;left:10px;background-color:#fdfdbe;box-shadow:3px 3px 10px;top:25px;">
<div id="W_x_sticky_header_0" style="background:#f3f3f3;height:20px;border-bottom:2px solid #fefefe;box-shadow:0 3px 5px rgba(0,0,0,0.25);padding:5px;"><span id="W_x_sticky_status_0" style="height:15px;float:left;margin:0;padding:3px;">Save</span> <span id="W_x_sticky_close_0" style="height:15px;float:right;margin:0;padding:3px;">Hide</span></div>
<div id="W_x_sticky_content_0" style="min-height:100px;word-wrap:break-word;border-left:3px double rgba(238,150,122,.75);margin-left:20px;padding:1px 5px;">Note Here</div>
</div>
